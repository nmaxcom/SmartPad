"use strict";(self.webpackChunksmartpad_docs=self.webpackChunksmartpad_docs||[]).push([[373],{6083(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"specs/resultchipsandvaluegraph","title":"SmartPad Result Chips + Value Graph Spec (V2)","description":"This spec extends Live Result into a full interaction model where results are:","source":"@site/docs/specs/resultchipsandvaluegraph.md","sourceDirName":"specs","slug":"/specs/resultchipsandvaluegraph","permalink":"/docs/specs/resultchipsandvaluegraph","draft":false,"unlisted":false,"editUrl":"https://github.com/nmaxcom/SmartPad/tree/main/website/docs/specs/resultchipsandvaluegraph.md","tags":[],"version":"current","frontMatter":{"title":"SmartPad Result Chips + Value Graph Spec (V2)","description":"This spec extends Live Result into a full interaction model where results are:"}}');var s=i(4848),l=i(8453);const t={title:"SmartPad Result Chips + Value Graph Spec (V2)",description:"This spec extends Live Result into a full interaction model where results are:"},a=void 0,c={},d=[{value:"0) Product Intent",id:"0-product-intent",level:2},{value:"1) Scope",id:"1-scope",level:2},{value:"In scope",id:"in-scope",level:3},{value:"Out of scope (this version)",id:"out-of-scope-this-version",level:3},{value:"2) UX Pillars",id:"2-ux-pillars",level:2},{value:"3) Feature Overview",id:"3-feature-overview",level:2},{value:"4) Visual System",id:"4-visual-system",level:2},{value:"4.1 Result Lane (Desktop)",id:"41-result-lane-desktop",level:3},{value:"4.2 Responsive Behavior",id:"42-responsive-behavior",level:3},{value:"4.3 Chip States (Game-feel inspired)",id:"43-chip-states-game-feel-inspired",level:3},{value:"5) Interaction Model",id:"5-interaction-model",level:2},{value:"5.1 Click to insert reference",id:"51-click-to-insert-reference",level:3},{value:"5.2 Drag chip into expression",id:"52-drag-chip-into-expression",level:3},{value:"5.3 Copy/paste chip as reference",id:"53-copypaste-chip-as-reference",level:3},{value:"6) Broken Dependency UX (Requested &quot;tax&quot; case)",id:"6-broken-dependency-ux-requested-tax-case",level:2},{value:"7) Internal Data Model",id:"7-internal-data-model",level:2},{value:"7.1 Stable IDs",id:"71-stable-ids",level:3},{value:"7.2 Reference Node",id:"72-reference-node",level:3},{value:"7.3 Serialization",id:"73-serialization",level:3},{value:"8) System Integration",id:"8-system-integration",level:2},{value:"8.1 Parser / AST",id:"81-parser--ast",level:3},{value:"8.2 Evaluator",id:"82-evaluator",level:3},{value:"8.3 Dependency Graph",id:"83-dependency-graph",level:3},{value:"8.4 Decorator / Rendering",id:"84-decorator--rendering",level:3},{value:"8.5 Undo/Redo",id:"85-undoredo",level:3},{value:"8.6 Settings",id:"86-settings",level:3},{value:"8.7 Live Result Expansion Rules",id:"87-live-result-expansion-rules",level:3},{value:"8.8 Current SmartPad Touchpoints (Implementation map)",id:"88-current-smartpad-touchpoints-implementation-map",level:3},{value:"9) Interaction Rules and Edge Cases",id:"9-interaction-rules-and-edge-cases",level:2},{value:"10) Accessibility",id:"10-accessibility",level:2},{value:"11) Performance Targets",id:"11-performance-targets",level:2},{value:"12) Telemetry / Product Success Metrics",id:"12-telemetry--product-success-metrics",level:2},{value:"13) Rollout Plan",id:"13-rollout-plan",level:2},{value:"Phase 1: Visual foundation",id:"phase-1-visual-foundation",level:3},{value:"Phase 2: Reference insertion",id:"phase-2-reference-insertion",level:3},{value:"Phase 3: Broken-link resilience",id:"phase-3-broken-link-resilience",level:3},{value:"Phase 4: Export/interop polish",id:"phase-4-exportinterop-polish",level:3},{value:"14) Acceptance Criteria",id:"14-acceptance-criteria",level:2},{value:"15) Example End-to-End Sheet",id:"15-example-end-to-end-sheet",level:2}];function o(e){const n={blockquote:"blockquote",br:"br",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Source: ",(0,s.jsx)(n.code,{children:"docs/Specs/ResultChipsAndValueGraph.spec.md"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This spec extends Live Result into a full interaction model where results are:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"always readable and aligned,"}),"\n",(0,s.jsx)(n.li,{children:"directly manipulable in the editor,"}),"\n",(0,s.jsx)(n.li,{children:"reusable as dependencies without exposing raw reference syntax to end users."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Core principle:\nResult chips are first-class computational objects, not second-class preview badges."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"0-product-intent",children:"0) Product Intent"}),"\n",(0,s.jsx)(n.p,{children:"SmartPad should feel like a playable simulation of math, not a static text editor."}),"\n",(0,s.jsx)(n.p,{children:"Users should be able to:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"read sheets quickly (clear alignment),"}),"\n",(0,s.jsx)(n.li,{children:"build formulas by touching values directly (click/drag/paste chips),"}),"\n",(0,s.jsx)(n.li,{children:"trust dependency behavior when source values change or break."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Plain explanation:\nInstead of typing abstract references like ",(0,s.jsx)(n.code,{children:"@L12"}),", people work with visible chips. SmartPad handles hidden linking internally."]}),"\n",(0,s.jsx)(n.p,{children:"Technical explanation:\nReferences are stored as structured inline reference nodes tied to stable source line IDs and evaluated via dependency graph edges."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"1-scope",children:"1) Scope"}),"\n",(0,s.jsx)(n.h3,{id:"in-scope",children:"In scope"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Result lane alignment and spacing system."}),"\n",(0,s.jsx)(n.li,{children:"Chip interaction model (click insert, drag/drop, copy/paste as reference)."}),"\n",(0,s.jsxs)(n.li,{children:["Hidden internal references (no visible ",(0,s.jsx)(n.code,{children:"@L12"})," in SmartPad UI)."]}),"\n",(0,s.jsx)(n.li,{children:"Broken-source states and dependency error UX."}),"\n",(0,s.jsx)(n.li,{children:"Parser/evaluator/dependency graph integration for reference nodes."}),"\n",(0,s.jsx)(n.li,{children:"Export/import strategy for preserving references."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"out-of-scope-this-version",children:"Out of scope (this version)"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Multiplayer conflict-resolution UX polish."}),"\n",(0,s.jsx)(n.li,{children:"Formula debugger timeline/replay UI."}),"\n",(0,s.jsx)(n.li,{children:"AI-assisted formula suggestions."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"2-ux-pillars",children:"2) UX Pillars"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Legibility at speed."}),"\n",(0,s.jsx)(n.li,{children:"Direct manipulation over symbolic syntax."}),"\n",(0,s.jsx)(n.li,{children:"Safe failure states with clear recovery."}),"\n",(0,s.jsx)(n.li,{children:"Equal visual weight for live and explicit results."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"3-feature-overview",children:"3) Feature Overview"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Feature"}),(0,s.jsx)(n.th,{children:"Plain explanation"}),(0,s.jsx)(n.th,{children:"Technical explanation"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Result Lane"}),(0,s.jsx)(n.td,{children:"Results line up in one clean vertical lane, so scanning is instant."}),(0,s.jsx)(n.td,{children:"Desktop editor computes a lane anchor and positions result widgets at a shared x-offset; narrow viewports collapse to inline mode."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Chip as Value"}),(0,s.jsx)(n.td,{children:"You can click/drag/copy a chip into another expression to reuse it."}),(0,s.jsxs)(n.td,{children:["Interaction inserts a ",(0,s.jsx)(n.code,{children:"resultReference"})," inline node with ",(0,s.jsx)(n.code,{children:"sourceLineId"}),"/",(0,s.jsx)(n.code,{children:"sourceResultId"})," attrs, not plain text."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Hidden References"}),(0,s.jsxs)(n.td,{children:["Users never see raw ",(0,s.jsx)(n.code,{children:"@L12"})," tokens while editing."]}),(0,s.jsx)(n.td,{children:"Internal serialization can use reference keys, but runtime editor view renders only chip nodes."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Broken Source UX"}),(0,s.jsx)(n.td,{children:'If source value breaks, dependent chips show clear "broken link" state.'}),(0,s.jsxs)(n.td,{children:["Resolver marks reference unresolved with cause code (",(0,s.jsx)(n.code,{children:"source_error"}),", ",(0,s.jsx)(n.code,{children:"missing_source"}),", ",(0,s.jsx)(n.code,{children:"type_mismatch"}),"), and decorator renders stateful chip + inline warning."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Type-Safe Chaining"}),(0,s.jsx)(n.td,{children:"Units/currency/list/number semantics propagate through references."}),(0,s.jsx)(n.td,{children:"Evaluator resolves referenced semantic value before expression evaluation; no lossy string interpolation."})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"4-visual-system",children:"4) Visual System"}),"\n",(0,s.jsx)(n.h3,{id:"41-result-lane-desktop",children:"4.1 Result Lane (Desktop)"}),"\n",(0,s.jsx)(n.p,{children:"Rules:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Input content flows naturally on the left."}),"\n",(0,s.jsx)(n.li,{children:"Results align to a fixed lane on the right (same x for each line)."}),"\n",(0,s.jsx)(n.li,{children:"If a line is too long, expression wraps before colliding with lane."}),"\n",(0,s.jsx)(n.li,{children:"Live and explicit outputs render in the same lane style."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"ASCII mock:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"monthly rent = 2500                              [2,500]\nphone bill   = 45                                   [45]\nfood = 50/day * 30 days                          [1,500]\ntotal cost per month                             [4,045]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Spacing/alignment targets:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"4px baseline rhythm."}),"\n",(0,s.jsx)(n.li,{children:"Chip height fixed per typography size."}),"\n",(0,s.jsx)(n.li,{children:"Minimum 12px gutter between expression end and first chip edge."}),"\n",(0,s.jsx)(n.li,{children:"Vertical optical alignment anchored to expression baseline midpoint."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"42-responsive-behavior",children:"4.2 Responsive Behavior"}),"\n",(0,s.jsx)(n.p,{children:"On narrow widths, result lane collapses to inline mode:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"food = 50/day * 30 days [1,500]\n"})}),"\n",(0,s.jsx)(n.p,{children:"No behavior change, layout only."}),"\n",(0,s.jsx)(n.h3,{id:"43-chip-states-game-feel-inspired",children:"4.3 Chip States (Game-feel inspired)"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Idle: normal chip."}),"\n",(0,s.jsx)(n.li,{children:"Hover: subtle glow/elevation."}),"\n",(0,s.jsx)(n.li,{children:"Grabbed: chip follows pointer with ghost origin."}),"\n",(0,s.jsx)(n.li,{children:"Valid drop target: caret highlight."}),"\n",(0,s.jsx)(n.li,{children:"Invalid drop target: shake + reject pulse."}),"\n",(0,s.jsx)(n.li,{children:"Broken reference: warning border + warning icon."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Plain explanation:\nThese micro-states make the feature feel intentional and tactile."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"5-interaction-model",children:"5) Interaction Model"}),"\n",(0,s.jsx)(n.h3,{id:"51-click-to-insert-reference",children:"5.1 Click to insert reference"}),"\n",(0,s.jsx)(n.p,{children:"Flow:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"User places caret in expression."}),"\n",(0,s.jsx)(n.li,{children:"User clicks a source result chip."}),"\n",(0,s.jsx)(n.li,{children:"SmartPad inserts a reference chip token at caret."}),"\n",(0,s.jsx)(n.li,{children:"If caret is on the same source line as the clicked live result, SmartPad creates a new line and inserts the chip there (prevents self-reference loops)."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"User sees:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"tax = [monthly rent] * 0.15\n"})}),"\n",(0,s.jsx)(n.p,{children:"User does not see:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"tax = @L12 * 0.15\n"})}),"\n",(0,s.jsx)(n.h3,{id:"52-drag-chip-into-expression",children:"5.2 Drag chip into expression"}),"\n",(0,s.jsx)(n.p,{children:"Flow:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Drag source result chip."}),"\n",(0,s.jsx)(n.li,{children:"Drop into target line."}),"\n",(0,s.jsx)(n.li,{children:"Reference token inserted at drop position."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"53-copypaste-chip-as-reference",children:"5.3 Copy/paste chip as reference"}),"\n",(0,s.jsx)(n.p,{children:"Flow:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Copy selected chip."}),"\n",(0,s.jsx)(n.li,{children:"Paste into expression."}),"\n",(0,s.jsx)(n.li,{children:"Insert linked chip reference (not literal text) when destination supports rich format."}),"\n",(0,s.jsx)(n.li,{children:"For SmartPad text round-trip, serialize as SmartPad reference token (not literal value)."}),"\n",(0,s.jsxs)(n.li,{children:["For external plain-text export, behavior follows ",(0,s.jsx)(n.code,{children:"referenceTextExportMode"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Guardrails:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Copy interception must apply only when a reference chip node itself is selected."}),"\n",(0,s.jsx)(n.li,{children:"Normal line/multi-line copy must keep native editor behavior (no single-chip clipboard hijack)."}),"\n",(0,s.jsx)(n.li,{children:"Pasting rich SmartPad content with chips should preserve chips and linked behavior."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"6-broken-dependency-ux-requested-tax-case",children:'6) Broken Dependency UX (Requested "tax" case)'}),"\n",(0,s.jsx)(n.p,{children:"Desired appearance:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"subtotal = 120                                      [120]\ntax = [subtotal] * 0.15                              [18]\n\n# source line later breaks:\nsubtotal = 12 / 0                                    [\u26a0 Division by zero]\ntax = [subtotal \u26a0] * 0.15                            \u26a0 source line has error\n"})}),"\n",(0,s.jsx)(n.p,{children:"Behavior:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Reference chip turns warning state immediately."}),"\n",(0,s.jsx)(n.li,{children:"Line result suppression follows current live policy (no noisy cascading stack traces by default)."}),"\n",(0,s.jsxs)(n.li,{children:["Inline helper appears: ",(0,s.jsx)(n.code,{children:"source line has error"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Clicking warning chip jumps to source line."}),"\n",(0,s.jsxs)(n.li,{children:["When live preview is blocked on a source line, the result-lane blocked chip renders the reason text inline (not ",(0,s.jsx)(n.code,{children:"..."})," with hover-only tooltip)."]}),"\n",(0,s.jsx)(n.li,{children:"Blocked chips use the same error typography treatment as inline error results (15px size, normal weight, pink error text)."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Plain explanation:\nIf an upstream value breaks, downstream formulas tell you exactly why and where."}),"\n",(0,s.jsx)(n.p,{children:"Technical explanation:\nDependency graph propagates invalidation status with source node metadata; renderer maps it to reference-chip state and contextual message."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"7-internal-data-model",children:"7) Internal Data Model"}),"\n",(0,s.jsx)(n.h3,{id:"71-stable-ids",children:"7.1 Stable IDs"}),"\n",(0,s.jsxs)(n.p,{children:["Each line has stable ",(0,s.jsx)(n.code,{children:"lineId"})," (UUID-like) independent of visual line number."]}),"\n",(0,s.jsx)(n.p,{children:"Why:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Reordering lines must not break references."}),"\n",(0,s.jsx)(n.li,{children:"Insertions/deletions should preserve links."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"72-reference-node",children:"7.2 Reference Node"}),"\n",(0,s.jsx)(n.p,{children:"New inline AST/editor node:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'type ResultReferenceNode = {\n  type: "resultReference";\n  sourceLineId: string;\n  sourceResultSlot: "primary";\n  fallbackLiteral?: string;\n  displayLabel?: string; // user-facing chip label\n};\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"displayLabel"})," is rendered UI text. ",(0,s.jsx)(n.code,{children:"sourceLineId"})," is the authority."]}),"\n",(0,s.jsx)(n.h3,{id:"73-serialization",children:"7.3 Serialization"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"SmartPad JSON (save/load): preserve structured node attributes."}),"\n",(0,s.jsx)(n.li,{children:"Clipboard rich format (SmartPad-aware destinations): preserve structured node."}),"\n",(0,s.jsx)(n.li,{children:"Text serialization for SmartPad round-trip: preserve references in a SmartPad-readable token syntax."}),"\n",(0,s.jsxs)(n.li,{children:["External plain-text export: user-selectable mode:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"preserve"})," (emit SmartPad-readable reference tokens)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"readable"})," (emit flattened visible values)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Note:\nRaw symbolic refs are for export/debug tooling, not normal SmartPad editing UI."}),"\n",(0,s.jsxs)(n.p,{children:["Plain explanation:\nWhen you save or copy inside SmartPad, links should stay links.",(0,s.jsx)(n.br,{}),"\n","When you export for humans outside SmartPad, you can choose readable text instead."]}),"\n",(0,s.jsx)(n.p,{children:"Reference token format policy:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Authority is stable source identity (",(0,s.jsx)(n.code,{children:"lineId"}),"/result slot) only."]}),"\n",(0,s.jsxs)(n.li,{children:["Relative-position syntax (e.g. ",(0,s.jsx)(n.code,{children:"line-4"}),") is not used as reference authority."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"@ref[lineId=line_mlfrrlf1_a6j5m3;slot=primary]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Meaning:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lineId"})," is what SmartPad trusts."]}),"\n",(0,s.jsx)(n.li,{children:"References remain stable across insert/delete/reorder because identity is line-based, not position-based."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"8-system-integration",children:"8) System Integration"}),"\n",(0,s.jsx)(n.h3,{id:"81-parser--ast",children:"8.1 Parser / AST"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Parse reference tokens as ",(0,s.jsx)(n.code,{children:"resultReference"})," components."]}),"\n",(0,s.jsx)(n.li,{children:"Keep existing expression parsing semantics unchanged for non-reference content."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"82-evaluator",children:"8.2 Evaluator"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Resolve each ",(0,s.jsx)(n.code,{children:"resultReference"})," to semantic value from source line result cache."]}),"\n",(0,s.jsx)(n.li,{children:"Preserve value type (number/unit/currency/date/list/etc)."}),"\n",(0,s.jsx)(n.li,{children:"If source unresolved, emit typed dependency error reason."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"83-dependency-graph",children:"8.3 Dependency Graph"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Add/maintain reference dependency awareness so target lines re-evaluate when source lines change."}),"\n",(0,s.jsx)(n.li,{children:"On source failure, propagate invalidation metadata."}),"\n",(0,s.jsx)(n.li,{children:"Formal explicit edge graph + strict subgraph scheduling are planned for scale stage (see Section 11 policy)."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"84-decorator--rendering",children:"8.4 Decorator / Rendering"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Render line result chips in lane or inline mode."}),"\n",(0,s.jsx)(n.li,{children:"Render inserted reference nodes as inline chips in expression text flow."}),"\n",(0,s.jsx)(n.li,{children:"Render warning state and helper text for broken references."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"85-undoredo",children:"8.5 Undo/Redo"}),"\n",(0,s.jsx)(n.p,{children:"Reference insertion/removal must be atomic editor transactions."}),"\n",(0,s.jsx)(n.h3,{id:"86-settings",children:"8.6 Settings"}),"\n",(0,s.jsx)(n.p,{children:"Add:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"resultLaneEnabled"})," (default: true desktop, auto-collapse on narrow widths)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"chipInsertMode"})," (default: click inserts reference)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"referenceTextExportMode"})," with values:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"preserve"})," (default): keep SmartPad stable-ID reference tokens in text copy/export."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"readable"}),": flatten references to current visible values."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Plain explanation:\nBy default SmartPad keeps references alive when copying/exporting text, so pasted content can come back as real chips later."}),"\n",(0,s.jsx)(n.h3,{id:"87-live-result-expansion-rules",children:"8.7 Live Result Expansion Rules"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Live result should render for non-trivial assignment RHS values even without ",(0,s.jsx)(n.code,{children:"=>"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Non-trivial means: includes math operators, conversion keywords, percentage phrase operators (",(0,s.jsx)(n.code,{children:"of/on/off/as/is/per"}),"), known variables, or function calls."]}),"\n",(0,s.jsxs)(n.li,{children:["Simple literal assignments (e.g. ",(0,s.jsx)(n.code,{children:"x = 42"}),", ",(0,s.jsx)(n.code,{children:"tax = 8%"}),", ",(0,s.jsx)(n.code,{children:"price = $120"}),") do not render live chips by default."]}),"\n",(0,s.jsxs)(n.li,{children:["While user is in incomplete comparator/trigger states (e.g. trailing ",(0,s.jsx)(n.code,{children:"="})," before typing ",(0,s.jsx)(n.code,{children:">"}),"), live result is suppressed to avoid placeholder gibberish/noise."]}),"\n",(0,s.jsxs)(n.li,{children:["Phrase-based percentage expressions (e.g. ",(0,s.jsx)(n.code,{children:"discount off base price"}),", ",(0,s.jsx)(n.code,{children:"tax on final price"}),") bypass unresolved-identifier pre-check and are evaluated directly."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"88-current-smartpad-touchpoints-implementation-map",children:"8.8 Current SmartPad Touchpoints (Implementation map)"}),"\n",(0,s.jsx)(n.p,{children:"Expected primary touchpoints in current codebase:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"src/components/Editor.tsx"}),"\nEvaluates lines, builds render nodes, dispatches ",(0,s.jsx)(n.code,{children:"evaluationDone"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"src/components/ResultsDecoratorExtension.ts"}),"\nRenders result widgets and warning/broken states; candidate home for lane placement logic."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"src/eval/renderNodes.ts"}),"\nExtend render node contracts for reference metadata and broken-reference hints."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"src/parsing/*"})," and AST component types\nAdd ",(0,s.jsx)(n.code,{children:"resultReference"})," component parsing/serialization."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"src/state/dependencyGraph.ts"}),"\nAdd explicit edges for reference-node dependencies."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"src/state/settingsStore.ts"})," + ",(0,s.jsx)(n.code,{children:"src/state/types.ts"}),"\nAdd lane/reference interaction settings."]}),"\n",(0,s.jsx)(n.li,{children:"Export/import pipeline (sheet serialization and clipboard handlers)\nPreserve structured reference nodes in rich format and deterministic fallback in plain text."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"9-interaction-rules-and-edge-cases",children:"9) Interaction Rules and Edge Cases"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Dragging chip into comments/plain text inserts literal text, not reference node."}),"\n",(0,s.jsx)(n.li,{children:"Dropping onto invalid syntax position shows reject animation and no insert."}),"\n",(0,s.jsx)(n.li,{children:"Deleting source line marks dependent refs as missing source."}),"\n",(0,s.jsx)(n.li,{children:"Copying sheet section with both source and dependents should remap links within pasted block when possible."}),"\n",(0,s.jsx)(n.li,{children:"If remap impossible, keep external link or downgrade to literal based on paste option."}),"\n",(0,s.jsx)(n.li,{children:"Cycles are detected and shown as cycle errors on participating lines."}),"\n",(0,s.jsxs)(n.li,{children:["Typing intermediate trigger text (e.g. ",(0,s.jsx)(n.code,{children:"="})," while building ",(0,s.jsx)(n.code,{children:"=>"}),") must never surface internal reference placeholders in live UI output."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"10-accessibility",children:"10) Accessibility"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:'Keyboard command for "insert last result reference" at caret.'}),"\n",(0,s.jsx)(n.li,{children:"Reference chips are focusable and announce source label/value."}),"\n",(0,s.jsx)(n.li,{children:"Broken chips announce error cause and provide keyboard jump-to-source action."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"11-performance-targets",children:"11) Performance Targets"}),"\n",(0,s.jsx)(n.p,{children:"Current delivery policy:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Maintain acceptable typing responsiveness and correctness for current sheet sizes."}),"\n",(0,s.jsx)(n.li,{children:"Allow broader reevaluation paths while feature behavior stabilizes."}),"\n",(0,s.jsx)(n.li,{children:"Defer strict subgraph-only scheduling and hard P95 budgets to scale stage."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Scale-stage targets (activated when scale signals appear):"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Incremental re-eval only for changed line + dependent subgraph."}),"\n",(0,s.jsx)(n.li,{children:"No full-document re-evaluation on each keypress."}),"\n",(0,s.jsx)(n.li,{children:"P95 extra UI latency from chip rendering under 8ms for 500-line sheets."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"12-telemetry--product-success-metrics",children:"12) Telemetry / Product Success Metrics"}),"\n",(0,s.jsx)(n.p,{children:"Current delivery policy:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Telemetry wiring is optional during stabilization."}),"\n",(0,s.jsx)(n.li,{children:"Functional correctness and UX clarity are prioritized first."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Scale-stage telemetry package:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"result_lane_enabled_rate"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"chip_reference_insert_total"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"chip_reference_drag_total"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"chip_reference_paste_total"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"dependency_broken_total"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"broken_ref_recovery_click_total"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"avg_formula_build_time_ms"})," (session-level derived)"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Interpretation goals:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Higher chip insert/drag usage = direct-manipulation adoption."}),"\n",(0,s.jsx)(n.li,{children:"Lower manual retyping events = less friction."}),"\n",(0,s.jsx)(n.li,{children:"Faster formula build time = real productivity gain."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"13-rollout-plan",children:"13) Rollout Plan"}),"\n",(0,s.jsx)(n.h3,{id:"phase-1-visual-foundation",children:"Phase 1: Visual foundation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Result lane + spacing/alignment system."}),"\n",(0,s.jsx)(n.li,{children:"Unified chip prominence for live and explicit results."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-2-reference-insertion",children:"Phase 2: Reference insertion"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Click/drag/paste creates hidden reference nodes."}),"\n",(0,s.jsx)(n.li,{children:"Basic dependency graph links."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-3-broken-link-resilience",children:"Phase 3: Broken-link resilience"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Broken reference states."}),"\n",(0,s.jsx)(n.li,{children:"Jump-to-source and recovery actions."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-4-exportinterop-polish",children:"Phase 4: Export/interop polish"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Rich clipboard round-trip."}),"\n",(0,s.jsx)(n.li,{children:"Export mode options (readable vs symbolic)."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"14-acceptance-criteria",children:"14) Acceptance Criteria"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Users never see raw ",(0,s.jsx)(n.code,{children:"@Lxx"})," syntax while editing in SmartPad."]}),"\n",(0,s.jsx)(n.li,{children:"Clicking a result chip at a valid caret inserts a reference chip node."}),"\n",(0,s.jsx)(n.li,{children:"Drag/drop and copy/paste chip references work in rich editor mode."}),"\n",(0,s.jsx)(n.li,{children:"Reordering lines does not break existing references."}),"\n",(0,s.jsx)(n.li,{children:"Source error produces broken-state reference chips and clear helper message on dependents."}),"\n",(0,s.jsx)(n.li,{children:"Result lane aligns chips consistently across long sheets on desktop."}),"\n",(0,s.jsx)(n.li,{children:"Narrow layout auto-collapses gracefully to inline chips."}),"\n",(0,s.jsx)(n.li,{children:"Unit/currency references preserve semantic types in downstream calculations."}),"\n",(0,s.jsx)(n.li,{children:"Undo/redo correctly replays chip insertion/removal."}),"\n",(0,s.jsx)(n.li,{children:"Performance targets are met on representative large sheets."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"15-example-end-to-end-sheet",children:"15) Example End-to-End Sheet"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"monthly rent = 2500                               [2,500]\nphone bill = 45                                      [45]\nfood/day = 50                                         [50]\nfood total = [food/day] * 30                       [1,500]\nmonthly total = [monthly rent] + [phone bill] + [food total]    [4,045]\n\n# later, source breaks:\nfood/day = unknownVar + 2                            [\u26a0 unresolved]\nfood total = [food/day \u26a0] * 30                       \u26a0 source line has error\nmonthly total = [monthly rent] + [phone bill] + [food total \u26a0]  \u26a0 source line has error\n"})}),"\n",(0,s.jsx)(n.p,{children:'This is the intended "it just makes sense" behavior:'}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"readable,"}),"\n",(0,s.jsx)(n.li,{children:"composable,"}),"\n",(0,s.jsx)(n.li,{children:"resilient."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453(e,n,i){i.d(n,{R:()=>t,x:()=>a});var r=i(6540);const s={},l=r.createContext(s);function t(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);